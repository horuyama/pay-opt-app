<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>最適決済マップ（自動キャンペーン反映）</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN",sans-serif;margin:0}
    header{padding:10px 14px;border-bottom:1px solid #eee;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    h1{font-size:16px;margin:0}
    #map{height:64vh}
    .panel{padding:10px 14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start}
    label{font-size:12px;color:#555}
    input,textarea,button{font-size:14px;padding:8px;border:1px solid #ddd;border-radius:8px}
    textarea{width:360px;height:72px}
    button.primary{background:#111;color:#fff;border-color:#111;cursor:pointer}
    .card{border:1px solid #eee;border-radius:12px;padding:12px;margin-top:10px}
    .small{font-size:12px;color:#666}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f2f2f2;font-size:12px;margin-right:6px}
    .result-ttl{font-weight:600;font-size:16px;margin:0 0 4px}
    .list{display:flex;overflow:auto;gap:8px;padding:6px 0}
    .chip{border:1px solid #ddd;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer;white-space:nowrap}
    .chip.sel{background:#111;color:#fff;border-color:#111}
  </style>
  <script>if('serviceWorker' in navigator){navigator.serviceWorker.register('service-worker.js');}</script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
</head>
<body>
<header>
  <h1>最適決済マップ</h1>
  <span class="small">複数CSVを定期ポーリング→自動マージ。地図タップで店舗判定。</span>
</header>
<div id="map"></div>

<div class="panel">
  <div class="row">
    <div style="flex:1;min-width:260px">
      <label>キャンペーンCSV URL（複数可。1行=1URL）</label><br>
      <textarea id="campaignUrls" placeholder="https://.../pub?output=csv"></textarea>
      <div class="small">衝突時は <b>priority</b> 降順 → <b>bonus_rate_percent</b> 降順。</div>
    </div>
    <div>
      <label>更新間隔（分・最短10）</label><br>
      <input id="pollMins" type="number" value="180" style="width:120px">
      <div style="margin-top:6px"><button id="loadCampaigns">今すぐ読込／開始</button></div>
    </div>
  </div>

  <div id="poiWrap" class="card" style="display:none">
    <div class="small">候補（近い順）</div>
    <div id="poiList" class="list"></div>
  </div>

  <div id="result" class="card" style="display:none"></div>
  <div id="campList" class="card" style="display:none"></div>

  <div class="small" style="margin-top:8px">
    付属CSV: <a href="pay_opt_rules.csv">ルール</a> ／ <a href="pay_opt_campaigns.csv">サンプル</a>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
const RULES_CSV_PATH = "pay_opt_rules.csv";
let RULES = [];
let CAMPAIGNS = [];
let lastMarker = null;
let pollTimer = null;

function parseCSV(csv){
  const lines = csv.split(/\r?\n/).filter(x=>x!=='');
  const out=[];
  for (let line of lines){
    const row=[]; let cur=''; let inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch==='"'){ if(inQ && line[i+1]==='"'){cur+='"'; i++;} else inQ=!inQ; }
      else if (ch===',' && !inQ){ row.push(cur); cur=''; }
      else { cur+=ch; }
    }
    row.push(cur); out.push(row);
  }
  return out;
}

async function loadRules(){
  const res = await fetch(RULES_CSV_PATH); if(!res.ok) return;
  const rows = parseCSV(await res.text());
  const idx = Object.fromEntries((rows[0]||[]).map((h,i)=>[h,i]));
  RULES = rows.slice(1).map(r=>({
    category:r[idx["category"]]||"",
    merchant_pattern:r[idx["merchant_pattern"]]||"",
    card:r[idx["card"]]||"",
    rate_percent:parseFloat(r[idx["rate_percent"]]||"0"),
    reason:r[idx["reason"]]||""
  }));
}

async function fetchCampaignCSV(url){
  try{
    const res = await fetch(url, {cache:'no-store'});
    if(!res.ok) throw 0;
    const rows = parseCSV(await res.text());
    const idx = Object.fromEntries((rows[0]||[]).map((h,i)=>[h,i]));
    const arr = rows.slice(1).map(r=>({
      merchant_pattern:r[idx["merchant_pattern"]]||"",
      category:r[idx["category"]]||"",
      card_override:r[idx["card_override"]]||"",
      bonus_rate_percent:parseFloat(r[idx["bonus_rate_percent"]]||"0"),
      start_date:r[idx["start_date"]]||"",
      end_date:r[idx["end_date"]]||"",
      note:r[idx["note"]]||"",
      source:r[idx["source"]]||"",
      priority:parseInt(r[idx["priority"]]||"0")
    })).filter(x=>x.merchant_pattern && x.start_date && x.end_date);
    return arr;
  }catch(e){ return []; }
}

async function refreshCampaigns(urlsText){
  const urls = urlsText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  let merged=[];
  for (const u of urls){
    const part = await fetchCampaignCSV(u);
    merged = merged.concat(part);
  }
  // 期限内のみ保持
  const today = new Date().toISOString().slice(0,10);
  CAMPAIGNS = merged.filter(c=>{
    const s=new Date(c.start_date+"T00:00:00");
    const e=new Date(c.end_date+"T23:59:59");
    const t=new Date(today+"T00:00:00");
    return t>=s && t<=e;
  }).sort((a,b)=>(b.priority||0)-(a.priority||0)||(b.bonus_rate_percent||0)-(a.bonus_rate_percent||0));
}

function startPolling(){
  if (pollTimer) clearInterval(pollTimer);
  const mins = Math.max(10, parseInt(document.getElementById('pollMins').value||'180'));
  const urls = document.getElementById('campaignUrls').value;
  const run = ()=>refreshCampaigns(urls);
  run();
  pollTimer = setInterval(run, mins*60*1000);
}

function activeCampaignsFor(hay, baseCat){
  const hits=[];
  for (const c of CAMPAIGNS){
    const re=new RegExp(c.merchant_pattern,'i');
    if(hay && !re.test(hay)) continue;
    if(c.category && baseCat && c.category!==baseCat) continue;
    hits.push(c);
  }
  return hits;
}

function bestFor(name, tagText){
  const hay=(name||"")+" "+(tagText||"");
  const matched = RULES.filter(r=>new RegExp(r.merchant_pattern,'i').test(hay));
  let base = matched.length ? matched.sort((a,b)=>b.rate_percent-a.rate_percent)[0] : RULES.find(r=>r.category.includes("一般"));
  const camps = activeCampaignsFor(hay, base?.category||"");
  const eff = Object.assign({}, base);
  const applied=[];
  for (const c of camps){
    if(c.card_override) eff.card=c.card_override;
    eff.rate_percent=(parseFloat(eff.rate_percent)||0)+(parseFloat(c.bonus_rate_percent)||0);
    applied.push(c);
  }
  return {eff, applied};
}

function render(name, addr, tags, bundle, latlng){
  const res=document.getElementById('result');
  const cm=document.getElementById('campList');
  const {eff, applied}=bundle;
  res.style.display='block';
  res.innerHTML = `
    <div class="pill">推奨</div>
    <div class="result-ttl">${eff.card}</div>
    <div class="small">推定還元率: <b>${(eff.rate_percent||0).toFixed(2)}</b>%</div>
    <div class="small">店舗: <b>${name||'(名称不明)'}</b> ／ ${addr||''}</div>
    <div class="small">タグ: ${tags||'-'}</div>`;
  cm.style.display='block';
  cm.innerHTML = applied.length
    ? '<div class="pill">適用キャンペーン</div>' + applied.map(c=>`
      <div class="small" style="margin-top:6px">
        <b>+${c.bonus_rate_percent}%</b>（${c.start_date}〜${c.end_date}）｜優先度 ${c.priority||0}<br>
        対象: <code>${c.merchant_pattern}</code> ${c.category?('／カテゴリ: '+c.category):''}<br>
        ${c.card_override?('カード指定: <b>'+c.card_override+'</b><br>'):''}
        ${c.note?('メモ: '+c.note+' '):''}${c.source?('<span class="small">['+c.source+']</span>'):''}
      </div>`).join('')
    : '<div class="small">該当するキャンペーンはありません。</div>';
  if (lastMarker) map.removeLayer(lastMarker);
  lastMarker = L.marker(latlng).addTo(map).bindPopup(`${name||'店舗'}<br><b>${eff.card}</b> / ${(eff.rate_percent||0).toFixed(2)}%`).openPopup();
}

function showPOIChips(pois, onPick){
  const wrap=document.getElementById('poiWrap');
  const list=document.getElementById('poiList');
  if(!pois.length){wrap.style.display='none'; return;}
  wrap.style.display='block'; list.innerHTML='';
  pois.slice(0,8).forEach((p,i)=>{
    const el=document.createElement('div');
    el.className='chip'+(i===0?' sel':'');
    el.textContent = p.name || (p.tags.brand||p.tags.operator) || p.tags.shop || p.tags.amenity || '(名称不明)';
    el.onclick = ()=>{ [...list.children].forEach(c=>c.classList.remove('sel')); el.classList.add('sel'); onPick(p); };
    list.appendChild(el);
  });
}

async function overpassAround(lat, lon){
  const q = `[out:json][timeout:10];
    (node(around:70,${lat},${lon})[name];
     node(around:70,${lat},${lon})[brand];
     node(around:70,${lat},${lon})[amenity];
     node(around:70,${lat},${lon})[shop];
     way(around:70,${lat},${lon})[name];
     way(around:70,${lat},${lon})[brand];
     way(around:70,${lat},${lon})[amenity];
     way(around:70,${lat},${lon})[shop];);
     out tags center 30;`;
  const res = await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q});
  const json = await res.json();
  return (json.elements||[]).map(e=>({
    name: e.tags?.name || '', addr: e.tags?.addr_full || '', tags: e.tags || {},
    lat: (e.lat||e.center?.lat), lon: (e.lon||e.center?.lon)
  }));
}

// Map init
const map = L.map('map', { zoomControl:true }).setView([35.681236,139.767125], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 20}).addTo(map);

// Tap to query & judge
map.on('click', async (ev)=>{
  const pois = await overpassAround(ev.latlng.lat, ev.latlng.lng);
  showPOIChips(pois, (p)=>{
    const name = p.name || p.tags.brand || p.tags.operator || '';
    const tagText = [p.tags.shop,p.tags.amenity,p.tags.brand,p.tags.operator].filter(Boolean).join(' ');
    const bundle = bestFor(name, tagText);
    const latlng = L.latLng(p.lat||ev.latlng.lat, p.lon||ev.latlng.lng);
    render(name, p.addr, tagText, bundle, latlng);
  });
  if (pois.length){
    const p = pois[0];
    const name = p.name || p.tags.brand || p.tags.operator || '';
    const tagText = [p.tags.shop,p.tags.amenity,p.tags.brand,p.tags.operator].filter(Boolean).join(' ');
    const bundle = bestFor(name, tagText);
    const latlng = L.latLng(p.lat||ev.latlng.lat, p.lon||ev.latlng.lng);
    render(name, p.addr, tagText, bundle, latlng);
  } else {
    const bundle = bestFor('', '', '');
    render('(名称不明)', '', '', bundle, ev.latlng);
  }
});

document.getElementById('loadCampaigns').addEventListener('click', ()=>{
  startPolling();
  alert('キャンペーンの自動更新を開始しました');
});

// polling
let pollTimer=null;
function startPolling(){
  if (pollTimer) clearInterval(pollTimer);
  const mins = Math.max(10, parseInt(document.getElementById('pollMins').value||'180'));
  const urls = document.getElementById('campaignUrls').value;
  const run = ()=>refreshCampaigns(urls);
  run();
  pollTimer = setInterval(run, mins*60*1000);
}

async function refreshCampaigns(urlsText){
  const urls = urlsText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  let merged=[];
  for (const u of urls){
    const part = await fetchCampaignCSV(u);
    merged = merged.concat(part);
  }
  const today = new Date().toISOString().slice(0,10);
  CAMPAIGNS = merged.filter(c=>{
    const s=new Date(c.start_date+"T00:00:00");
    const e=new Date(c.end_date+"T23:59:59");
    const t=new Date(today+"T00:00:00");
    return t>=s && t<=e;
  }).sort((a,b)=>(b.priority||0)-(a.priority||0)||(b.bonus_rate_percent||0)-(a.bonus_rate_percent||0));
}

loadRules();
startPolling();
</script>
</body>
</html>
