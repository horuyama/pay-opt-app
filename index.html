<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Pay Optimizer Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <!-- Leaflet CSS（unpkg → jsDelivr）-->
  <link id="lf-css-1" rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <link id="lf-css-2" rel="stylesheet alternate" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css?v=cdn2">
  <!-- 地図高さのフォールバック（外部CSSが落ちても地図を出す） -->
  <style>
    html,body{height:100%;margin:0}
    #map{position:absolute;inset:48px 0 0 0}
  </style>
</head>
<body>
  <header class="bar">
    <div class="title">Pay Optimizer Map</div>
    <div class="actions">
      <button id="scan">周辺をスキャン</button>
      <button id="loc">現在地</button>
    </div>
  </header>
  <div id="map"></div>
  <div class="legend">
    <span class="dot dot-hot"></span>キャンペーン適用候補
    <span class="dot dot-cold"></span>通常店舗
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // Leaflet JS（unpkg→jsDelivr の順でフェイルオーバー）
    (function(){
      function toast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);}
      function load(src, cb){var s=document.createElement('script');s.src=src;s.crossOrigin='anonymous';s.defer=true;
        s.onload=()=>cb();s.onerror=()=>cb(new Error('load error'));document.body.appendChild(s);}
      load('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', function(e1){
        if(typeof L==='undefined'||e1){ toast('CDN切替中…'); load('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js', function(e2){
          if(typeof L==='undefined'||e2){ toast('Leaflet読み込み失敗'); } else { var s=document.createElement('script'); s.src='app.js?v=cdn2'; s.defer=true; document.body.appendChild(s); }
        }); }
        else { var s=document.createElement('script'); s.src='app.js?v=cdn2'; s.defer=true; document.body.appendChild(s); }
      });
    })();
  </script>
</body>
</html>